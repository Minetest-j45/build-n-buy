bnb_schems = {}
bnb_schems.modname = minetest.get_current_modname()

bnb_schems.place = function(pos, schemname, rot, replace, force_place)
    minetest.place_schematic(pos, minetest.get_modpath(bnb_schems.modname).."/schems/"..schemname..".mts", rot, replace, force_place)
end

bnb_schems.demos = {
    -- originals
    "tree",
    "camp",
    "lilly",
    "fire",
    "pokeball",
    "yinyang",
    "cave",
    "present",
    "bed",
    "cactus",
    "heart",
    "minion",
    "flower",
    "moon",
    "clash",
    "stash",
    -- by Wuzzy
    "castle",
    "cloud",
    "clearing",
    "containment",
    "furnace",
    "lava_crater",
    "mese_shrine",
    "orange",
    "portal",
    "ritual",
    "sign",
    "wasteland",
    "well",
    "ruin",
    "sewer",
    "lab_leak",
    "staircase",
    "beach",
    "bling_bling",
    "bling_floor",
    "coal_vein",
    "cursed_lava",
    "cursed_sand",
    "desert_statue",
    "dirt_hut",
    "wood_hut",
    "lava_flow",
    "mese_monument",
    "mese_vein",
    "M",
    "oasis",
    "snowland",
    "spring",
    "stone_circle",
    "traffic_lights",
    "pipe",
    "sheep",
    "snowmelt",
    "drizzle",
    "rain",
    "puddle",
    "mosaic_window",
    "collapsed_cave",
    "island",
    "crystal",
}

bnb_schems.last_last_demo = ""
bnb_schems.last_demo = ""
bnb_schems.random_demo = function()
    local random = math.random(1, #bnb_schems.demos)
    local demo = bnb_schems.demos[random]
    if demo == bnb_schems.last_demo or demo == bnb_schems.last_last_demo then
        return bnb_schems.random_demo()
    else
        bnb_schems.last_last_demo = bnb_schems.last_demo
        bnb_schems.last_demo = demo
        return demo
    end
end

bnb_schems.place_demo = function(minpos, maxpos)
    local demo = bnb_schems.random_demo()
    minetest.emerge_area(minpos, maxpos, function(blockpos, action, remaining)
        if remaining == 0 then
            bnb_schems.place(minpos, "demo_"..demo, 0, nil, true)
            -- replace underscores with spaces for chat msg
            local print_name = string.gsub(demo, "_", " ")
            minetest.chat_send_all(minetest.colorize("#71aa34", "You now have to build a "..print_name.."!"))
        end
    end)
end

minetest.after(1, function()
bnb_schems.analyze = function(demoname)
    local schem = minetest.read_schematic(minetest.get_modpath(bnb_schems.modname).."/schems/demo_"..demoname..".mts", {})
    if schem then
       minetest.chat_send_all(demoname..": "..minetest.pos_to_string(schem.size))
       local nodes = 0
       for d=1, #schem.data do
	       local dat = schem.data[d]
	       if dat.name ~= "air" and dat.prob > 1 then
		       nodes = nodes + 1
	       end
       end
       minetest.chat_send_all(demoname..": "..nodes.." node(s)")
    else
       minetest.chat_send_all(demoname..": ERROR")
    end
end

       minetest.chat_send_all(#bnb_schems.demos)
for d=1, #bnb_schems.demos do
   local demoname = bnb_schems.demos[d]
   bnb_schems.analyze(demoname)
end
end)
